<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ city }} / {{ circle }} · Local Square</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="container">
    <h2>{{ city }} / {{ circle }}</h2>
    <div id="chat">
      {% for (nick, text, ts) in history %}
        <div class="msg"><b>{{ nick }}</b>: {{ text }}</div>
      {% endfor %}
    </div>
    <form id="send" onsubmit="sendMsg(event)">
      <input type="text" id="text" placeholder="Say something..." autocomplete="off" maxlength="200" required>
      <button>Send</button>
    </form>
    <a href="/">← change circle</a>
  </div>

<script>
const nick = sessionStorage.getItem('nick') || 'anon';
const city = "{{ city }}";
const circle = "{{ circle }}";
const ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + `/ws/${city}/${circle}`);

ws.onmessage = (ev) => {
  const m = JSON.parse(ev.data);
  const chat = document.getElementById('chat');
  const div = document.createElement('div');
  div.className = 'msg';
  div.innerHTML = `<b>${escapeHtml(m.nick)}</b>: ${escapeHtml(m.text)}`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
};

function sendMsg(e){
  e.preventDefault();
  const input = document.getElementById('text');
  const text = input.value.trim();
  if(!text) return;
  ws.send(JSON.stringify({nick, text}));
  input.value='';
}

function escapeHtml(s){
  return s.replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
}
</script>
</body>
</html>
